<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- basic -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- mobile metas -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <!-- site metas -->
    <title>èˆªç­é¢„è®¢ - èˆªç©ºç¥¨åŠ¡ç³»ç»Ÿ</title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="author" content="">
    <!-- bootstrap css -->
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <!-- style css -->
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <!-- Responsive-->
    <link rel="stylesheet" href="css/responsive.css">
    <!-- fevicon -->
    <link rel="icon" href="images/fevicon.png" type="image/gif" />
    <!-- Scrollbar Custom CSS -->
    <link rel="stylesheet" href="css/jquery.mCustomScrollbar.min.css">
    <!-- Tweaks for older IEs-->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.0.3/css/font-awesome.css">
    <!-- owl stylesheets -->
    <link rel="stylesheet" href="css/owl.carousel.min.css">
    <link rel="stylesheet" href="css/owl.theme.default.min.css">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css" media="screen">

    <style>
        /* é¢„è®¢é¡µé¢ä¸“ç”¨æ ·å¼ */
        .booking-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px 15px;
        }

        .booking-header {
            text-align: center;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .booking-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .booking-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .flight-info-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }

        .card-title {
            color: #333;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .card-title i {
            margin-right: 10px;
            color: #667eea;
        }

        .flight-route {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        .airport {
            text-align: center;
            flex: 1;
        }

        .airport-code {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .airport-name {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .flight-arrow {
            flex: 0 0 100px;
            text-align: center;
            position: relative;
        }

        .flight-arrow::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 20%;
            right: 20%;
            height: 2px;
            background: #667eea;
            transform: translateY(-50%);
        }

        .flight-arrow::after {
            content: 'âœˆ';
            font-size: 20px;
            color: #667eea;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 0 5px;
        }

        .flight-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-item {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .detail-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .passenger-form {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-left: 5px solid #28a745;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .form-control {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .form-control:read-only {
            background-color: #f8f9fa;
            border-color: #dee2e6;
        }

        .seat-selection {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-left: 5px solid #ffc107;
        }

        .seat-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .seat-option {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .seat-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .seat-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .seat-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .seat-option.disabled:hover {
            border-color: #e9ecef;
            background: #f5f5f5;
        }

        .seat-type {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .seat-price {
            font-size: 24px;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 5px;
        }

        .seat-option.selected .seat-price {
            color: white;
        }

        .seat-features {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .seat-option.selected .seat-features {
            color: rgba(255,255,255,0.8);
        }

        .seat-availability {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .seat-option.selected .seat-availability {
            color: rgba(255,255,255,0.7);
        }

        .price-summary {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-left: 5px solid #e74c3c;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .price-row:last-child {
            border-bottom: none;
            padding-top: 15px;
            margin-top: 10px;
            font-size: 20px;
            font-weight: bold;
        }

        .discount-info {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #8b4513;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
        }

        .booking-actions {
            text-align: center;
            margin-top: 30px;
        }

        .btn-book {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            border-radius: 25px;
            padding: 15px 50px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
            margin-right: 15px;
        }

        .btn-book:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .btn-book:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-cancel {
            background: #6c757d;
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            font-size: 18px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .vip-badge {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #8b4513;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        .info-message {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
<!-- header section start -->
<div class="header_section">
    <div class="container">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="logo"><a href="index.html"><img src="images/logo.png"></a></div>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <a class="nav-item nav-link" href="main.html">ä¸»é¡µ</a>
                <a class="nav-item nav-link" href="search.html">èˆªç­æŸ¥è¯¢</a>
                <a class="nav-item nav-link" href="booking.html">èˆªç­é¢„è®¢</a>
                <a class="nav-item nav-link" href="personal.html">ä¸ªäººä¿¡æ¯ç®¡ç†</a>
                <a class="nav-item nav-link" href="admin.html">ç®¡ç†å‘˜æ“ä½œ</a>
            </div>
        </nav>
    </div>
</div>
<!-- header section end -->

<!-- èˆªç­é¢„è®¢ä¸»ä½“éƒ¨åˆ† -->
<div class="booking-container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="booking-header">
        <div class="booking-title">èˆªç­é¢„è®¢ç¡®è®¤</div>
        <div class="booking-subtitle">è¯·ç¡®è®¤æ‚¨çš„èˆªç­ä¿¡æ¯å¹¶å¡«å†™ä¹˜å®¢è¯¦æƒ…</div>
    </div>

    <!-- é”™è¯¯æˆ–æˆåŠŸæ¶ˆæ¯ -->
    <div id="messageContainer"></div>

    <!-- èˆªç­ä¿¡æ¯å¡ç‰‡ -->
    <div class="flight-info-card">
        <div class="card-title">
            <i class="fa fa-plane"></i>
            èˆªç­ä¿¡æ¯
        </div>

        <!-- èˆªçº¿æ˜¾ç¤º -->
        <div class="flight-route">
            <div class="airport">
                <div class="airport-code" id="departureCode">åŠ è½½ä¸­...</div>
                <div class="airport-name" id="departureName">...</div>
            </div>
            <div class="flight-arrow"></div>
            <div class="airport">
                <div class="airport-code" id="arrivalCode">åŠ è½½ä¸­...</div>
                <div class="airport-name" id="arrivalName">...</div>
            </div>
        </div>

        <!-- èˆªç­è¯¦æƒ… -->
        <div class="flight-details">
            <div class="detail-item">
                <div class="detail-label">èˆªç­å·</div>
                <div class="detail-value" id="flightNumber">åŠ è½½ä¸­...</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">èˆªç©ºå…¬å¸</div>
                <div class="detail-value" id="airlineName">åŠ è½½ä¸­...</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">å‡ºå‘æ—¶é—´</div>
                <div class="detail-value" id="departureTime">åŠ è½½ä¸­...</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">åˆ°è¾¾æ—¶é—´</div>
                <div class="detail-value" id="arrivalTime">åŠ è½½ä¸­...</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">èˆªç­æ—¥æœŸ</div>
                <div class="detail-value" id="flightDate">åŠ è½½ä¸­...</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">é£è¡Œæ—¶é•¿</div>
                <div class="detail-value" id="flightDuration">è®¡ç®—ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- ä¹˜å®¢ä¿¡æ¯è¡¨å• -->
    <div class="passenger-form">
        <div class="card-title">
            <i class="fa fa-user"></i>
            ä¹˜å®¢ä¿¡æ¯
            <span id="vipBadgeContainer"></span>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label">å§“å</label>
                    <input type="text" class="form-control" id="passengerName" placeholder="åŠ è½½ä¸­..." readonly>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·ID</label>
                    <input type="text" class="form-control" id="userId" placeholder="åŠ è½½ä¸­..." readonly>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label">æ‰‹æœºå·</label>
                    <input type="tel" class="form-control" id="passengerPhone" placeholder="åŠ è½½ä¸­..." readonly>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label">ä¼šå‘˜çŠ¶æ€</label>
                    <input type="text" class="form-control" id="vipStatus" placeholder="åŠ è½½ä¸­..." readonly>
                </div>
            </div>
        </div>
    </div>

    <!-- åº§ä½é€‰æ‹© -->
    <div class="seat-selection">
        <div class="card-title">
            <i class="fa fa-th"></i>
            é€‰æ‹©åº§ä½ç±»å‹
        </div>

        <!-- VIPæŠ˜æ‰£æç¤º -->
        <div id="vipDiscountInfo" style="display: none;"></div>

        <div class="seat-options" id="seatOptions">
            <div class="seat-option" data-seat-type="0" onclick="selectSeat(0)">
                <div class="seat-type">ç»æµèˆ±</div>
                <div class="seat-price" id="economyPrice">Â¥åŠ è½½ä¸­...</div>
                <div class="seat-features">æ ‡å‡†åº§ä½ â€¢ å…è´¹é¤é£Ÿ â€¢ 20kgè¡Œæ</div>
                <div class="seat-availability" id="economyAvailability">æ£€æŸ¥åº§ä½...</div>
            </div>
            <div class="seat-option" data-seat-type="1" onclick="selectSeat(1)">
                <div class="seat-type">å•†åŠ¡èˆ±</div>
                <div class="seat-price" id="businessPrice">Â¥åŠ è½½ä¸­...</div>
                <div class="seat-features">å®½æ•åº§ä½ â€¢ ä¼˜è´¨é¤é£Ÿ â€¢ 30kgè¡Œæ â€¢ ä¼˜å…ˆç™»æœº</div>
                <div class="seat-availability" id="businessAvailability">æ£€æŸ¥åº§ä½...</div>
            </div>
        </div>
    </div>

    <!-- ä»·æ ¼æ±‡æ€» -->
    <div class="price-summary">
        <div class="card-title">
            <i class="fa fa-calculator"></i>
            è´¹ç”¨æ˜ç»†
        </div>

        <div id="originalPriceRow" style="display: none;" class="price-row">
            <span>åŸä»·</span>
            <span id="originalPrice">Â¥0</span>
        </div>
        <div id="discountRow" style="display: none;" class="price-row">
            <span id="discountLabel">VIPæŠ˜æ‰£</span>
            <span id="discountAmount">-Â¥0</span>
        </div>
        <div class="price-row">
            <span>æœºç¥¨è´¹ç”¨</span>
            <span id="ticketPrice">Â¥0</span>
        </div>
        <div class="price-row">
            <span>æœåŠ¡è´¹</span>
            <span>Â¥0</span>
        </div>
        <div class="price-row">
            <span>æ€»è®¡</span>
            <span id="totalPrice">Â¥0</span>
        </div>
    </div>

    <!-- é¢„è®¢æ“ä½œæŒ‰é’® -->
    <div class="booking-actions">
        <button class="btn-book" id="bookBtn" onclick="confirmBooking()" disabled>
            <i class="fa fa-spinner fa-spin"></i> åŠ è½½ä¸­...
        </button>
        <button class="btn-cancel" onclick="cancelBooking()">
            <i class="fa fa-arrow-left"></i> è¿”å›æœç´¢
        </button>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div class="loading" id="loadingDiv">
        <div class="loading-spinner"></div>
        <div>æ­£åœ¨å¤„ç†æ‚¨çš„é¢„è®¢...</div>
    </div>
</div>

<!-- footer section start -->
<div class="layout_padding footer_section">
    <div class="container">
        <div class="row">
            <div class="col-sm-6 col-md-6 col-lg-3">
                <div class="footer_logo"><img src="images/footer-logo.png"></div>
                <p class="dolor_text">åèˆªèˆªç©ºèˆªç­ç¥¨åŠ¡ç³»ç»Ÿ <br>Copyright Â© 2025 All rights reserved.</p>
            </div>
            <div class="col-sm-6 col-md-6 col-lg-3">
                <h1 class="quick_text">æ›´å¤šåŠŸèƒ½</h1>
                <div class="chevron_arrow"><img src="images/chevron-arrow.png"><span class="padding-left">åŠ å…¥æˆ‘ä»¬</span></div>
                <div class="chevron_arrow"><img src="images/chevron-arrow.png"><span class="padding-left">ç»´æŠ¤è€…</span></div>
                <div class="chevron_arrow"><img src="images/chevron-arrow.png"><span class="padding-left">ç‰ˆæœ¬çŠ¶æ€</span></div>
            </div>
            <div class="col-sm-6 col-md-6 col-lg-3">
                <h1 class="quick_text">è”ç³»æˆ‘ä»¬</h1>
                <div class="map_flag"><img src="images/map-flag.png"><span class="padding-left">123 Main Street, Anytown USA</span></div>
                <div class="map_flag"><img src="images/email-icon.png"><span class="padding-left">abcd@gmail.com</span></div>
                <div class="map_flag"><img src="images/phone-icon.png"><span class="padding-left">+123 456 7890</span></div>
            </div>
        </div>
    </div>
</div>
<!-- footer section end -->

<!-- Javascript files-->
<script src="js/jquery.min.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/jquery-3.0.0.min.js"></script>
<script src="js/plugin.js"></script>
<script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
<script src="js/custom.js"></script>
<script src="js/owl.carousel.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.js"></script>

<script>
    // å…¨å±€å˜é‡
    let selectedSeatType = 0; // é»˜è®¤é€‰æ‹©ç»æµèˆ±
    let flightrecordId = null;
    let flightInfo = null;
    let currentUser = null;
    let priceInfo = {
        economy: { price: 0, originalPrice: 0, hasDiscount: false },
        business: { price: 0, originalPrice: 0, hasDiscount: false }
    };

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
        initializePage();
    });

    // åˆå§‹åŒ–é¡µé¢
    async function initializePage() {
        try {
            showMessage('æ­£åœ¨åŠ è½½èˆªç­å’Œç”¨æˆ·ä¿¡æ¯...', 'info');

            // 1. æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
            if (!checkLoginStatus()) {
                return;
            }

            // 2. è·å–URLå‚æ•°
            if (!getUrlParameters()) {
                return;
            }

            // 3. ä¼˜å…ˆåŠ è½½èˆªç­ä¿¡æ¯ï¼ˆå› ä¸ºç”¨æˆ·ä¿¡æ¯ç›¸å¯¹ç¨³å®šï¼‰
            try {
                await loadFlightInfo();
                console.log('âœ… èˆªç­ä¿¡æ¯åŠ è½½æˆåŠŸ');
            } catch (flightError) {
                console.warn('âš ï¸ èˆªç­ä¿¡æ¯åŠ è½½å¤±è´¥ï¼Œä½†ç»§ç»­åŠ è½½å…¶ä»–ä¿¡æ¯:', flightError.message);
                // ä¸è¦é˜»æ­¢åç»­åŠ è½½
            }

            // 4. åŠ è½½ç”¨æˆ·ä¿¡æ¯
            try {
                await loadUserInfo();
                console.log('âœ… ç”¨æˆ·ä¿¡æ¯åŠ è½½æˆåŠŸ');
            } catch (userError) {
                console.warn('âš ï¸ ç”¨æˆ·è¯¦ç»†ä¿¡æ¯åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜ä¿¡æ¯:', userError.message);
                // ä½¿ç”¨ç¼“å­˜çš„ç”¨æˆ·ä¿¡æ¯
                displayUserInfo();
            }

            // 5. åŠ è½½ä»·æ ¼ä¿¡æ¯
            try {
                await loadPriceInfo();
                console.log('âœ… ä»·æ ¼ä¿¡æ¯åŠ è½½æˆåŠŸ');
            } catch (priceError) {
                console.warn('âš ï¸ ä»·æ ¼ä¿¡æ¯åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä»·æ ¼:', priceError.message);
                // ä½¿ç”¨é»˜è®¤ä»·æ ¼
                priceInfo.economy.price = 500;
                priceInfo.business.price = 1200;
                updatePriceDisplay();
            }

            // 6. é»˜è®¤é€‰æ‹©ç»æµèˆ±
            selectSeat(0);

            // æ¸…é™¤åŠ è½½æ¶ˆæ¯
            clearMessages();
            showMessage('é¡µé¢åŠ è½½å®Œæˆï¼æ‚¨å¯ä»¥é€‰æ‹©åº§ä½ç±»å‹å¹¶ç¡®è®¤é¢„è®¢ã€‚', 'success');

            console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');

        } catch (error) {
            console.error('âŒ é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
            showMessage('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼š' + error.message + '\n\nå·²åŠ è½½é»˜è®¤ä¿¡æ¯ï¼Œæ‚¨ä»å¯ä»¥å°è¯•é¢„è®¢ã€‚', 'error');

            // å³ä½¿åˆå§‹åŒ–å¤±è´¥ï¼Œä¹Ÿè¦ç¡®ä¿é¡µé¢åŸºæœ¬å¯ç”¨
            if (!flightInfo) {
                createDefaultFlightInfo();
                updateFlightDisplay();
            }
            if (!currentUser.userName) {
                displayUserInfo();
            }
            updatePriceDisplay();
            selectSeat(0);
        }
    }

    // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
    function checkLoginStatus() {
        const userInfo = localStorage.getItem('userInfo');

        if (!userInfo) {
            localStorage.setItem('redirectUrl', window.location.href);
            showMessage('è¯·å…ˆç™»å½•åå†è¿›è¡Œé¢„è®¢', 'error');
            setTimeout(() => {
                window.location.href = 'sign_log.html';
            }, 2000);
            return false;
        }

        try {
            currentUser = JSON.parse(userInfo);
            console.log('âœ… å½“å‰ç”¨æˆ·:', currentUser);
            return true;
        } catch (error) {
            console.error('âŒ è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            localStorage.removeItem('userInfo');
            window.location.href = 'sign_log.html';
            return false;
        }
    }

    // è·å–URLå‚æ•°
    function getUrlParameters() {
        const urlParams = new URLSearchParams(window.location.search);
        flightrecordId = urlParams.get('flightrecordId');

        if (!flightrecordId) {
            showMessage('ç¼ºå°‘èˆªç­ä¿¡æ¯ï¼Œè¯·è¿”å›é‡æ–°é€‰æ‹©', 'error');
            setTimeout(() => {
                window.location.href = 'search.html';
            }, 2000);
            return false;
        }

        console.log('ğŸ“ èˆªç­è®°å½•ID:', flightrecordId);
        return true;
    }

    // åŠ è½½ç”¨æˆ·ä¿¡æ¯
    async function loadUserInfo() {
        try {
            console.log('ğŸ‘¤ å¼€å§‹åŠ è½½ç”¨æˆ·ä¿¡æ¯...');

            const response = await fetch('/api/users');
            if (!response.ok) {
                throw new Error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
            }

            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message || 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
            }

            // æŸ¥æ‰¾å½“å‰ç”¨æˆ·
            const userDetail = result.data.find(user => user.userId === currentUser.userId);
            if (!userDetail) {
                throw new Error('æœªæ‰¾åˆ°ç”¨æˆ·è¯¦ç»†ä¿¡æ¯');
            }

            // æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
            currentUser = { ...currentUser, ...userDetail };

            // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            displayUserInfo();

            console.log('âœ… ç”¨æˆ·ä¿¡æ¯åŠ è½½å®Œæˆ:', currentUser);

        } catch (error) {
            console.error('âŒ åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            // ä½¿ç”¨ç¼“å­˜çš„ç”¨æˆ·ä¿¡æ¯
            displayUserInfo();
            throw new Error('åŠ è½½ç”¨æˆ·è¯¦ç»†ä¿¡æ¯å¤±è´¥ï¼š' + error.message);
        }
    }

    // åŠ è½½èˆªç­ä¿¡æ¯
    async function loadFlightInfo() {
        try {
            console.log('âœˆï¸ å¼€å§‹åŠ è½½èˆªç­ä¿¡æ¯...');

            // ä»èˆªç­è®°å½•IDè§£æä¿¡æ¯
            const flightId = flightrecordId.substring(0, flightrecordId.length - 8);
            const flightDate = flightrecordId.substring(flightrecordId.length - 8);
            const formattedDate = `${flightDate.substring(0,4)}-${flightDate.substring(4,6)}-${flightDate.substring(6,8)}`;

            console.log('ğŸ“ è§£æèˆªç­ä¿¡æ¯:', {
                flightrecordId,
                flightId,
                flightDate,
                formattedDate
            });

            // æ–¹æ³•1: å…ˆå°è¯•ç›´æ¥ç”¨URLå‚æ•°æ„å»ºèˆªç­ä¿¡æ¯
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('airportFrom') && urlParams.has('airportTo')) {
                console.log('ğŸ“ ä»URLå‚æ•°è·å–èˆªç­ä¿¡æ¯');
                flightInfo = {
                    flightId: flightId,
                    flightrecordId: flightrecordId,
                    airlineName: urlParams.get('airlineName') || 'ä¸­å›½å—æ–¹èˆªç©º',
                    airportFrom: urlParams.get('airportFrom'),
                    airportTo: urlParams.get('airportTo'),
                    timeTakeoff: urlParams.get('timeTakeoff') || '08:30',
                    timeArrive: urlParams.get('timeArrive') || '11:15',
                    flightDate: formattedDate,
                    seat0Left: parseInt(urlParams.get('seat0Left')) || 50,
                    seat1Left: parseInt(urlParams.get('seat1Left')) || 10
                };

                updateFlightDisplay();
                console.log('âœ… ä»URLå‚æ•°åŠ è½½èˆªç­ä¿¡æ¯æˆåŠŸ:', flightInfo);
                return;
            }

            // æ–¹æ³•2: å°è¯•ä»localStorageè·å–æœ€è¿‘çš„æœç´¢ç»“æœ
            const recentSearch = localStorage.getItem('recentFlightSearch');
            if (recentSearch) {
                try {
                    const searchData = JSON.parse(recentSearch);
                    console.log('ğŸ“ ä»localStorageè·å–æœç´¢å‚æ•°:', searchData);

                    // ä½¿ç”¨æœ€è¿‘çš„æœç´¢å‚æ•°é‡æ–°æœç´¢
                    const searchResponse = await fetch('/api/flights/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            airportFrom: searchData.airportFrom,
                            airportTo: searchData.airportTo,
                            flightDate: searchData.flightDate || formattedDate,
                            userId: currentUser.userId
                        })
                    });

                    if (searchResponse.ok) {
                        const searchResult = await searchResponse.json();
                        console.log('ğŸ” æœç´¢APIå“åº”:', searchResult);

                        if (searchResult.success && searchResult.data && searchResult.data.length > 0) {
                            // æŸ¥æ‰¾åŒ¹é…çš„èˆªç­
                            let matchedFlight = searchResult.data.find(flight =>
                                flight.flightrecordId === flightrecordId ||
                                flight.flightId === flightId
                            );

                            // å¦‚æœæ²¡æ‰¾åˆ°å®Œå…¨åŒ¹é…ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªèˆªç­
                            if (!matchedFlight && searchResult.data.length > 0) {
                                console.warn('âš ï¸ æœªæ‰¾åˆ°å®Œå…¨åŒ¹é…çš„èˆªç­ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªèˆªç­');
                                matchedFlight = searchResult.data[0];
                                // æ›´æ–°èˆªç­è®°å½•IDä»¥åŒ¹é…å®é™…æ•°æ®
                                matchedFlight.flightrecordId = flightrecordId;
                            }

                            if (matchedFlight) {
                                flightInfo = matchedFlight;
                                updateFlightDisplay();
                                console.log('âœ… ä»æœç´¢APIåŠ è½½èˆªç­ä¿¡æ¯æˆåŠŸ:', flightInfo);
                                return;
                            }
                        }
                    }
                } catch (e) {
                    console.warn('âš ï¸ ä½¿ç”¨localStorageæœç´¢å¤±è´¥:', e);
                }
            }

            // æ–¹æ³•3: å°è¯•æ™ºèƒ½è§£æèˆªç­IDè·å–æœºåœºä¿¡æ¯
            console.log('ğŸ“ å°è¯•æ™ºèƒ½è§£æèˆªç­ID');
            let airportFrom = 'PEK';
            let airportTo = 'SHA';

            // å¸¸è§çš„èˆªç­å·æ ¼å¼è§£æ
            if (flightId.length >= 4) {
                // å¦‚æœèˆªç­å·ä»¥å¸¸è§å‰ç¼€å¼€å§‹ï¼Œå°è¯•è§£æ
                const airlineCode = flightId.substring(0, 2);
                const flightNumber = flightId.substring(2);

                // æ ¹æ®èˆªç©ºå…¬å¸ä»£ç æ¨æµ‹å¸¸è§èˆªçº¿
                const commonRoutes = {
                    'CZ': [['PEK', 'SHA'], ['PEK', 'CAN'], ['SHA', 'CAN']],
                    'CA': [['PEK', 'SHA'], ['PEK', 'PVG'], ['PEK', 'CAN']],
                    'MU': [['SHA', 'PEK'], ['PVG', 'PEK'], ['SHA', 'CAN']],
                    'FM': [['SHA', 'PEK'], ['PVG', 'CTU'], ['SHA', 'SZX']]
                };

                if (commonRoutes[airlineCode]) {
                    const routes = commonRoutes[airlineCode];
                    const routeIndex = parseInt(flightNumber) % routes.length;
                    [airportFrom, airportTo] = routes[routeIndex];
                    console.log('ğŸ“ æ ¹æ®èˆªç©ºå…¬å¸æ¨æµ‹èˆªçº¿:', airlineCode, airportFrom, '->', airportTo);
                }
            }

            // æœ€åå°è¯•ç”¨æ¨æµ‹çš„æœºåœºä¿¡æ¯æœç´¢
            console.log('ğŸ“ æœ€åå°è¯•ç”¨æ¨æµ‹ä¿¡æ¯æœç´¢èˆªç­');
            try {
                const searchResponse = await fetch('/api/flights/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        airportFrom: airportFrom,
                        airportTo: airportTo,
                        flightDate: formattedDate,
                        userId: currentUser.userId
                    })
                });

                if (searchResponse.ok) {
                    const searchResult = await searchResponse.json();
                    if (searchResult.success && searchResult.data && searchResult.data.length > 0) {
                        // ä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„èˆªç­ï¼Œå¹¶è°ƒæ•´ä¿¡æ¯
                        flightInfo = searchResult.data[0];
                        flightInfo.flightId = flightId;
                        flightInfo.flightrecordId = flightrecordId;
                        flightInfo.flightDate = formattedDate;

                        updateFlightDisplay();
                        console.log('âœ… ç”¨æ¨æµ‹ä¿¡æ¯æœç´¢æˆåŠŸ:', flightInfo);
                        return;
                    }
                }
            } catch (e) {
                console.warn('âš ï¸ æ¨æµ‹æœç´¢å¤±è´¥:', e);
            }

            // æ–¹æ³•4: å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œåˆ›å»ºé»˜è®¤èˆªç­ä¿¡æ¯
            console.log('ğŸ“ æ‰€æœ‰æœç´¢æ–¹æ³•å¤±è´¥ï¼Œåˆ›å»ºé»˜è®¤èˆªç­ä¿¡æ¯');
            createDefaultFlightInfo();
            updateFlightDisplay();
            console.log('âœ… ä½¿ç”¨é»˜è®¤èˆªç­ä¿¡æ¯:', flightInfo);

        } catch (error) {
            console.error('âŒ åŠ è½½èˆªç­ä¿¡æ¯å¤±è´¥:', error);
            // åˆ›å»ºé»˜è®¤ä¿¡æ¯ä½œä¸ºæœ€åçš„å¤‡é€‰æ–¹æ¡ˆ
            createDefaultFlightInfo();
            updateFlightDisplay();
            throw new Error('åŠ è½½èˆªç­ä¿¡æ¯å¤±è´¥ï¼Œå·²ä½¿ç”¨é»˜è®¤ä¿¡æ¯ï¼š' + error.message);
        }
    }

    // åˆ›å»ºé»˜è®¤èˆªç­ä¿¡æ¯
    function createDefaultFlightInfo() {
        const flightId = flightrecordId.substring(0, flightrecordId.length - 8);
        const flightDate = flightrecordId.substring(flightrecordId.length - 8);
        const formattedDate = `${flightDate.substring(0,4)}-${flightDate.substring(4,6)}-${flightDate.substring(6,8)}`;

        // æ ¹æ®èˆªç­å·æ¨æµ‹èˆªç©ºå…¬å¸
        let airlineName = 'ä¸­å›½å—æ–¹èˆªç©º';
        const airlineCode = flightId.substring(0, 2);
        const airlineNames = {
            'CZ': 'ä¸­å›½å—æ–¹èˆªç©º',
            'CA': 'ä¸­å›½å›½é™…èˆªç©º',
            'MU': 'ä¸­å›½ä¸œæ–¹èˆªç©º',
            'FM': 'ä¸Šæµ·èˆªç©º',
            '3U': 'å››å·èˆªç©º',
            'HU': 'æµ·å—èˆªç©º',
            'ZH': 'æ·±åœ³èˆªç©º',
            'SC': 'å±±ä¸œèˆªç©º'
        };

        if (airlineNames[airlineCode]) {
            airlineName = airlineNames[airlineCode];
        }

        flightInfo = {
            flightId: flightId,
            flightrecordId: flightrecordId,
            airlineName: airlineName,
            airportFrom: 'PEK',
            airportTo: 'SHA',
            timeTakeoff: '08:30',
            timeArrive: '11:15',
            flightDate: formattedDate,
            seat0Left: 50,  // é»˜è®¤ç»æµèˆ±åº§ä½
            seat1Left: 10   // é»˜è®¤å•†åŠ¡èˆ±åº§ä½
        };

        console.log('ğŸ“ åˆ›å»ºé»˜è®¤èˆªç­ä¿¡æ¯:', flightInfo);
    }

    // åŠ è½½ä»·æ ¼ä¿¡æ¯
    async function loadPriceInfo() {
        try {
            console.log('ğŸ’° å¼€å§‹åŠ è½½ä»·æ ¼ä¿¡æ¯...');

            // å¹¶è¡Œè·å–ç»æµèˆ±å’Œå•†åŠ¡èˆ±ä»·æ ¼
            const [economyResponse, businessResponse] = await Promise.all([
                fetch(`/api/booking/price?flightrecordId=${encodeURIComponent(flightrecordId)}&seatType=0&userId=${encodeURIComponent(currentUser.userId)}`),
                fetch(`/api/booking/price?flightrecordId=${encodeURIComponent(flightrecordId)}&seatType=1&userId=${encodeURIComponent(currentUser.userId)}`)
            ]);

            // å¤„ç†ç»æµèˆ±ä»·æ ¼
            if (economyResponse.ok) {
                const economyData = await economyResponse.json();
                if (economyData.success) {
                    priceInfo.economy.price = economyData.price;
                    console.log('âœ… ç»æµèˆ±ä»·æ ¼:', economyData.price);
                } else {
                    console.warn('âš ï¸ è·å–ç»æµèˆ±ä»·æ ¼å¤±è´¥:', economyData.message);
                    priceInfo.economy.price = 500; // é»˜è®¤ä»·æ ¼
                }
            } else {
                console.warn('âš ï¸ ç»æµèˆ±ä»·æ ¼APIè°ƒç”¨å¤±è´¥');
                priceInfo.economy.price = 500;
            }

            // å¤„ç†å•†åŠ¡èˆ±ä»·æ ¼
            if (businessResponse.ok) {
                const businessData = await businessResponse.json();
                if (businessData.success) {
                    priceInfo.business.price = businessData.price;
                    console.log('âœ… å•†åŠ¡èˆ±ä»·æ ¼:', businessData.price);
                } else {
                    console.warn('âš ï¸ è·å–å•†åŠ¡èˆ±ä»·æ ¼å¤±è´¥:', businessData.message);
                    priceInfo.business.price = 1200; // é»˜è®¤ä»·æ ¼
                }
            } else {
                console.warn('âš ï¸ å•†åŠ¡èˆ±ä»·æ ¼APIè°ƒç”¨å¤±è´¥');
                priceInfo.business.price = 1200;
            }

            // æ£€æŸ¥VIPæŠ˜æ‰£
            if (flightInfo && flightInfo.hasDiscount && currentUser.vipState === 'æ˜¯') {
                priceInfo.economy.originalPrice = flightInfo.originalPrice0 || priceInfo.economy.price;
                priceInfo.business.originalPrice = flightInfo.originalPrice1 || priceInfo.business.price;
                priceInfo.economy.hasDiscount = true;
                priceInfo.business.hasDiscount = true;
                console.log('ğŸ‰ æ£€æµ‹åˆ°VIPæŠ˜æ‰£');
            }

            // æ›´æ–°ä»·æ ¼æ˜¾ç¤º
            updatePriceDisplay();

            console.log('âœ… ä»·æ ¼ä¿¡æ¯åŠ è½½å®Œæˆ:', priceInfo);

        } catch (error) {
            console.error('âŒ åŠ è½½ä»·æ ¼ä¿¡æ¯å¤±è´¥:', error);
            // ä½¿ç”¨é»˜è®¤ä»·æ ¼
            priceInfo.economy.price = 500;
            priceInfo.business.price = 1200;
            updatePriceDisplay();
            throw new Error('åŠ è½½ä»·æ ¼ä¿¡æ¯å¤±è´¥ï¼š' + error.message);
        }
    }

    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
    function displayUserInfo() {
        if (!currentUser) return;

        document.getElementById('passengerName').value = currentUser.userName || '';
        document.getElementById('passengerPhone').value = currentUser.userTelephone || '';
        document.getElementById('userId').value = currentUser.userId || '';
        document.getElementById('vipStatus').value = currentUser.vipState === 'æ˜¯' ? 'VIPä¼šå‘˜' : 'æ™®é€šä¼šå‘˜';

        // æ˜¾ç¤ºVIPçŠ¶æ€
        if (currentUser.vipState === 'æ˜¯') {
            const vipBadge = document.createElement('span');
            vipBadge.className = 'vip-badge';
            vipBadge.innerHTML = '<i class="fa fa-crown"></i> VIPä¼šå‘˜';
            document.getElementById('vipBadgeContainer').appendChild(vipBadge);

            // æ˜¾ç¤ºVIPæŠ˜æ‰£ä¿¡æ¯
            const discountInfo = document.getElementById('vipDiscountInfo');
            discountInfo.innerHTML = '<div class="discount-info"><i class="fa fa-star"></i> æ­å–œï¼ä½œä¸ºVIPä¼šå‘˜ï¼Œæ‚¨å°†äº«å—ä¸“å±ä¼˜æƒ ä»·æ ¼</div>';
            discountInfo.style.display = 'block';
        }
    }

    // æ›´æ–°èˆªç­ä¿¡æ¯æ˜¾ç¤º
    function updateFlightDisplay() {
        if (!flightInfo) return;

        console.log('ğŸ–¼ï¸ æ›´æ–°èˆªç­æ˜¾ç¤º:', flightInfo);

        document.getElementById('flightNumber').textContent = flightInfo.flightId;
        document.getElementById('airlineName').textContent = flightInfo.airlineName;
        document.getElementById('departureCode').textContent = flightInfo.airportFrom;
        document.getElementById('departureName').textContent = getAirportName(flightInfo.airportFrom);
        document.getElementById('arrivalCode').textContent = flightInfo.airportTo;
        document.getElementById('arrivalName').textContent = getAirportName(flightInfo.airportTo);
        document.getElementById('departureTime').textContent = flightInfo.timeTakeoff;
        document.getElementById('arrivalTime').textContent = flightInfo.timeArrive;
        document.getElementById('flightDate').textContent = flightInfo.flightDate;

        // è®¡ç®—é£è¡Œæ—¶é•¿
        const duration = calculateFlightDuration(flightInfo.timeTakeoff, flightInfo.timeArrive);
        document.getElementById('flightDuration').textContent = duration;

        // æ›´æ–°åº§ä½å¯ç”¨æ€§
        const economySeats = parseInt(flightInfo.seat0Left) || 0;
        const businessSeats = parseInt(flightInfo.seat1Left) || 0;

        console.log('ğŸ’º åº§ä½ä¿¡æ¯ - ç»æµèˆ±:', economySeats, 'å•†åŠ¡èˆ±:', businessSeats);

        document.getElementById('economyAvailability').textContent = `å‰©ä½™ ${economySeats} åº§ä½`;
        document.getElementById('businessAvailability').textContent = `å‰©ä½™ ${businessSeats} åº§ä½`;

        // æ£€æŸ¥åº§ä½æ˜¯å¦å¯é€‰
        const economyOption = document.querySelector('[data-seat-type="0"]');
        const businessOption = document.querySelector('[data-seat-type="1"]');

        // é‡ç½®çŠ¶æ€
        economyOption.classList.remove('disabled');
        businessOption.classList.remove('disabled');
        economyOption.onclick = () => selectSeat(0);
        businessOption.onclick = () => selectSeat(1);

        // æ£€æŸ¥ç»æµèˆ±åº§ä½
        if (economySeats <= 0) {
            economyOption.classList.add('disabled');
            economyOption.onclick = null;
            document.getElementById('economyAvailability').textContent = 'åº§ä½å·²æ»¡';
            document.getElementById('economyAvailability').style.color = '#e74c3c';
            console.log('âŒ ç»æµèˆ±åº§ä½å·²æ»¡');
        } else {
            document.getElementById('economyAvailability').style.color = '#28a745';
            console.log('âœ… ç»æµèˆ±åº§ä½å¯ç”¨:', economySeats);
        }

        // æ£€æŸ¥å•†åŠ¡èˆ±åº§ä½
        if (businessSeats <= 0) {
            businessOption.classList.add('disabled');
            businessOption.onclick = null;
            document.getElementById('businessAvailability').textContent = 'åº§ä½å·²æ»¡';
            document.getElementById('businessAvailability').style.color = '#e74c3c';
            console.log('âŒ å•†åŠ¡èˆ±åº§ä½å·²æ»¡');
        } else {
            document.getElementById('businessAvailability').style.color = '#28a745';
            console.log('âœ… å•†åŠ¡èˆ±åº§ä½å¯ç”¨:', businessSeats);
        }
    }

    // æ›´æ–°ä»·æ ¼æ˜¾ç¤º
    function updatePriceDisplay() {
        // æ›´æ–°åº§ä½é€‰é¡¹ä¸­çš„ä»·æ ¼
        document.getElementById('economyPrice').textContent = 'Â¥' + priceInfo.economy.price;
        document.getElementById('businessPrice').textContent = 'Â¥' + priceInfo.business.price;

        // æ›´æ–°å½“å‰é€‰ä¸­åº§ä½çš„ä»·æ ¼æ±‡æ€»
        const currentPrice = selectedSeatType === 0 ? priceInfo.economy.price : priceInfo.business.price;
        const hasDiscount = selectedSeatType === 0 ? priceInfo.economy.hasDiscount : priceInfo.business.hasDiscount;
        const originalPrice = selectedSeatType === 0 ? priceInfo.economy.originalPrice : priceInfo.business.originalPrice;

        document.getElementById('ticketPrice').textContent = 'Â¥' + currentPrice;
        document.getElementById('totalPrice').textContent = 'Â¥' + currentPrice;

        // æ˜¾ç¤ºæŠ˜æ‰£ä¿¡æ¯
        if (hasDiscount && originalPrice && originalPrice > currentPrice) {
            document.getElementById('originalPriceRow').style.display = 'flex';
            document.getElementById('discountRow').style.display = 'flex';
            document.getElementById('originalPrice').textContent = 'Â¥' + originalPrice;
            document.getElementById('discountAmount').textContent = '-Â¥' + (originalPrice - currentPrice);
            document.getElementById('discountAmount').style.color = '#28a745';
        } else {
            document.getElementById('originalPriceRow').style.display = 'none';
            document.getElementById('discountRow').style.display = 'none';
        }

        // å¯ç”¨é¢„è®¢æŒ‰é’®
        updateBookButton();
    }

    // æ›´æ–°é¢„è®¢æŒ‰é’®çŠ¶æ€
    function updateBookButton() {
        const bookBtn = document.getElementById('bookBtn');
        if (!flightInfo) {
            bookBtn.disabled = true;
            bookBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> åŠ è½½ä¸­...';
            return;
        }

        const economySeats = parseInt(flightInfo.seat0Left) || 0;
        const businessSeats = parseInt(flightInfo.seat1Left) || 0;
        const hasAvailableSeats = (selectedSeatType === 0 && economySeats > 0) ||
            (selectedSeatType === 1 && businessSeats > 0);

        console.log('ğŸ”˜ æ›´æ–°é¢„è®¢æŒ‰é’®çŠ¶æ€:', {
            selectedSeatType,
            economySeats,
            businessSeats,
            hasAvailableSeats
        });

        if (hasAvailableSeats) {
            bookBtn.disabled = false;
            bookBtn.innerHTML = '<i class="fa fa-check"></i> ç¡®è®¤é¢„è®¢';
        } else {
            bookBtn.disabled = true;
            bookBtn.innerHTML = '<i class="fa fa-ban"></i> åº§ä½å·²æ»¡';
        }
    }

    // é€‰æ‹©åº§ä½ç±»å‹
    function selectSeat(seatType) {
        console.log('ğŸ¯ å°è¯•é€‰æ‹©åº§ä½ç±»å‹:', seatType);

        if (!flightInfo) {
            console.warn('âš ï¸ èˆªç­ä¿¡æ¯æœªåŠ è½½å®Œæˆ');
            return;
        }

        // æ£€æŸ¥åº§ä½æ˜¯å¦å¯ç”¨
        const economySeats = parseInt(flightInfo.seat0Left) || 0;
        const businessSeats = parseInt(flightInfo.seat1Left) || 0;

        const isAvailable = (seatType === 0 && economySeats > 0) ||
            (seatType === 1 && businessSeats > 0);

        console.log('ğŸ’º åº§ä½å¯ç”¨æ€§æ£€æŸ¥:', {
            seatType,
            economySeats,
            businessSeats,
            isAvailable
        });

        if (!isAvailable) {
            const seatTypeName = seatType === 0 ? 'ç»æµèˆ±' : 'å•†åŠ¡èˆ±';
            showMessage(`${seatTypeName}å·²æ— å¯ç”¨åº§ä½`, 'error');
            return;
        }

        selectedSeatType = seatType;

        // æ›´æ–°é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.seat-option').forEach(option => {
            option.classList.remove('selected');
        });

        const selectedOption = document.querySelector(`[data-seat-type="${seatType}"]`);
        if (selectedOption && !selectedOption.classList.contains('disabled')) {
            selectedOption.classList.add('selected');
        }

        // æ›´æ–°ä»·æ ¼æ˜¾ç¤º
        updatePriceDisplay();

        const seatTypeName = seatType === 0 ? 'ç»æµèˆ±' : 'å•†åŠ¡èˆ±';
        console.log('âœ… é€‰æ‹©åº§ä½ç±»å‹:', seatTypeName);
    }

    // ç¡®è®¤é¢„è®¢
    async function confirmBooking() {
        if (!currentUser || !flightInfo) {
            showMessage('ç”¨æˆ·ä¿¡æ¯æˆ–èˆªç­ä¿¡æ¯ä¸¢å¤±ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
            return;
        }

        // æ£€æŸ¥åº§ä½å¯ç”¨æ€§
        const economySeats = parseInt(flightInfo.seat0Left) || 0;
        const businessSeats = parseInt(flightInfo.seat1Left) || 0;
        const hasAvailableSeats = (selectedSeatType === 0 && economySeats > 0) ||
            (selectedSeatType === 1 && businessSeats > 0);

        console.log('ğŸ” é¢„è®¢å‰åº§ä½æ£€æŸ¥:', {
            selectedSeatType,
            economySeats,
            businessSeats,
            hasAvailableSeats
        });

        if (!hasAvailableSeats) {
            const seatTypeName = selectedSeatType === 0 ? 'ç»æµèˆ±' : 'å•†åŠ¡èˆ±';
            showMessage(`é€‰æ‹©çš„${seatTypeName}å·²æ— å¯ç”¨åº§ä½`, 'error');
            return;
        }

        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        const seatTypeName = selectedSeatType === 0 ? 'ç»æµèˆ±' : 'å•†åŠ¡èˆ±';
        const currentPrice = selectedSeatType === 0 ? priceInfo.economy.price : priceInfo.business.price;

        const confirmMsg = `ç¡®è®¤é¢„è®¢ä¿¡æ¯ï¼š\n\n` +
            `èˆªç­ï¼š${flightInfo.flightId}\n` +
            `æ—¥æœŸï¼š${flightInfo.flightDate}\n` +
            `èˆªçº¿ï¼š${flightInfo.airportFrom} â†’ ${flightInfo.airportTo}\n` +
            `èµ·é£æ—¶é—´ï¼š${flightInfo.timeTakeoff}\n` +
            `åˆ°è¾¾æ—¶é—´ï¼š${flightInfo.timeArrive}\n` +
            `åº§ä½ç±»å‹ï¼š${seatTypeName}\n` +
            `æ€»è´¹ç”¨ï¼šÂ¥${currentPrice}\n\n` +
            `ç¡®è®¤æäº¤é¢„è®¢å—ï¼Ÿ`;

        if (!confirm(confirmMsg)) {
            return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        showLoading(true);

        try {
            console.log('ğŸ“¤ æäº¤é¢„è®¢è¯·æ±‚...');

            const response = await fetch('/api/booking/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    flightrecordId: flightrecordId,
                    userId: currentUser.userId,
                    seatType: selectedSeatType
                })
            });

            const result = await response.json();

            if (result.success) {
                showMessage(`é¢„è®¢æˆåŠŸï¼\nè®¢å•å·ï¼š${result.orderId}\næ€»è´¹ç”¨ï¼šÂ¥${result.totalPrice}\nè®¢å•çŠ¶æ€ï¼š${result.orderState}`, 'success');

                console.log('âœ… é¢„è®¢æˆåŠŸ:', result);

                // å»¶è¿Ÿè·³è½¬
                setTimeout(() => {
                    window.location.href = 'personal.html';
                }, 3000);

            } else {
                console.error('âŒ é¢„è®¢å¤±è´¥:', result.message);
                showMessage('é¢„è®¢å¤±è´¥ï¼š' + result.message, 'error');
            }

        } catch (error) {
            console.error('âŒ é¢„è®¢è¯·æ±‚å¼‚å¸¸:', error);
            showMessage('é¢„è®¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•', 'error');
        } finally {
            showLoading(false);
        }
    }

    // å–æ¶ˆé¢„è®¢ï¼Œè¿”å›æœç´¢é¡µé¢
    function cancelBooking() {
        if (confirm('ç¡®å®šè¦å–æ¶ˆé¢„è®¢å—ï¼Ÿ')) {
            window.location.href = 'search.html';
        }
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoading(show) {
        const loadingDiv = document.getElementById('loadingDiv');
        const bookBtn = document.getElementById('bookBtn');

        if (show) {
            loadingDiv.style.display = 'block';
            bookBtn.disabled = true;
        } else {
            loadingDiv.style.display = 'none';
            updateBookButton();
        }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(message, type = 'info') {
        const container = document.getElementById('messageContainer');
        const messageDiv = document.createElement('div');

        let className = 'info-message';
        let icon = 'info-circle';

        if (type === 'error') {
            className = 'error-message';
            icon = 'exclamation-triangle';
        } else if (type === 'success') {
            className = 'success-message';
            icon = 'check-circle';
        }

        messageDiv.className = className;
        messageDiv.innerHTML = `<i class="fa fa-${icon}"></i> ${message.replace(/\n/g, '<br>')}`;

        container.innerHTML = '';
        container.appendChild(messageDiv);

        // è‡ªåŠ¨æ¶ˆå¤±ï¼ˆé™¤äº†é”™è¯¯æ¶ˆæ¯ï¼‰
        if (type !== 'error') {
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // æ»šåŠ¨åˆ°æ¶ˆæ¯ä½ç½®
        messageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // æ¸…é™¤æ¶ˆæ¯
    function clearMessages() {
        document.getElementById('messageContainer').innerHTML = '';
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„æœºåœºä»£ç 
    function isValidAirportCode(code) {
        const validCodes = ['PEK', 'SHA', 'PVG', 'CAN', 'SZX', 'CTU', 'KMG', 'XIY', 'HGH', 'NKG', 'TSN', 'WUH'];
        return validCodes.includes(code);
    }

    // è·å–æœºåœºåç§°
    function getAirportName(code) {
        const airportNames = {
            'PEK': 'åŒ—äº¬é¦–éƒ½å›½é™…æœºåœº',
            'SHA': 'ä¸Šæµ·è™¹æ¡¥å›½é™…æœºåœº',
            'PVG': 'ä¸Šæµ·æµ¦ä¸œå›½é™…æœºåœº',
            'CAN': 'å¹¿å·ç™½äº‘å›½é™…æœºåœº',
            'SZX': 'æ·±åœ³å®å®‰å›½é™…æœºåœº',
            'CTU': 'æˆéƒ½åŒæµå›½é™…æœºåœº',
            'KMG': 'æ˜†æ˜é•¿æ°´å›½é™…æœºåœº',
            'XIY': 'è¥¿å®‰å’¸é˜³å›½é™…æœºåœº',
            'HGH': 'æ­å·è§å±±å›½é™…æœºåœº',
            'NKG': 'å—äº¬ç¦„å£å›½é™…æœºåœº',
            'TSN': 'å¤©æ´¥æ»¨æµ·å›½é™…æœºåœº',
            'WUH': 'æ­¦æ±‰å¤©æ²³å›½é™…æœºåœº'
        };
        return airportNames[code] || code + 'æœºåœº';
    }

    // è®¡ç®—é£è¡Œæ—¶é•¿
    function calculateFlightDuration(takeoffTime, arriveTime) {
        try {
            const [takeoffHour, takeoffMin] = takeoffTime.split(':').map(Number);
            const [arriveHour, arriveMin] = arriveTime.split(':').map(Number);

            let takeoffMinutes = takeoffHour * 60 + takeoffMin;
            let arriveMinutes = arriveHour * 60 + arriveMin;

            // å¤„ç†è·¨æ—¥æƒ…å†µ
            if (arriveMinutes <= takeoffMinutes) {
                arriveMinutes += 24 * 60; // åŠ ä¸€å¤©
            }

            const durationMinutes = arriveMinutes - takeoffMinutes;
            const hours = Math.floor(durationMinutes / 60);
            const minutes = durationMinutes % 60;

            return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
        } catch (error) {
            return 'è®¡ç®—ä¸­...';
        }
    }
</script>
</body>
</html>